{
    "apiVersion": "v1",
    "data": {
        "__init__.py": "from __future__ import print_function\n\nimport os\nimport platform\n\nfrom buildbot.plugins import *\n\n\ndef get_os():\n    d = platform.linux_distribution()\n    os = d[0].lower()\n    if os not in ('ubuntu','debian','centos'):\n        if 'red hat' in os:\n            os = 'centos'\n        else:\n            raise Exception('unknown os: '+os)\n    ver = d[1].lower().split('/')[-1]\n    if os == 'centos':\n        ver = ver.split('.')[0]\n    try:\n        float(ver)\n    except:\n        return os+'_'+ver\n    else:\n        return os+ver\n\n\nclass WriteOnceDict(dict):\n    def __setitem__(self, key, value):\n        if key in self:\n            raise KeyError('{} has already been set'.format(key))\n        super(WriteOnceDict, self).__setitem__(key, value)\n\nclass Config(dict):\n    \"\"\"\n    A Config object, holding the setup for a BuildBot config.\n\n    Provide a setup function\n    \"\"\"\n    def __init__(self, setup=None):\n        self['change_source'] = WriteOnceDict()\n        self['workers'] = WriteOnceDict()\n        self['builders'] = WriteOnceDict()\n        self['schedulers'] = WriteOnceDict()\n\n        self.locks = WriteOnceDict()\n        self.codebases = WriteOnceDict()\n\n        self.dependencies = []\n        self.setup = setup\n\n    def register_dependency(self, dep):\n        self.dependencies.append(dep)\n\n    def __call__(self):\n        name = self.setup.__module__.split('.')[-1] if self.setup else 'None'\n        print(name,'pre-dep locks:',self.locks)\n        for d in self.dependencies:\n            d.locks.update(self.locks)\n            d()\n            self.codebases.update(d.codebases)\n            for k in self:\n                self[k].update(d[k])\n        dep_sched = [self['schedulers'][s].name for s in self['schedulers'] if self['schedulers'][s].__class__.__name__ == 'Triggerable']\n        dep_builders = set(self['builders'])\n\n        if self.setup:\n            print(name,'pre-setup locks:',self.locks)\n            self.setup(self)\n\n        # for any new factory made by setup, add dependency trigger\n        if dep_sched:\n            for b in self['builders']:\n                if b not in dep_builders:\n                    self['builders'][b].factory.addStep(steps.Trigger(\n                        schedulerNames=dep_sched,\n                        waitForFinish=False,\n                        updateSourceStamp=False,\n                    ))\n",
        "cvmfs.py": "from __future__ import print_function\n\nimport os\nimport json\nimport random\n\nfrom buildbot.plugins import *\nfrom buildbot.process.buildstep import SUCCESS,SKIPPED\n\nfrom . import Config, get_os\n\n\nprefix = __file__.split('/')[-1].rsplit('.',1)[0]\n\nworker_cfgs = {\n    'cvmfs-centos6-build': 'worker-cvmfs-centos6-build',\n    'cvmfs-centos7-build': 'worker-cvmfs-centos7-build',\n    'cvmfs-ubuntu14-04-build': 'worker-cvmfs-ubuntu14-04-build',\n    'cvmfs-ubuntu15-10-build': 'worker-cvmfs-ubuntu15-10-build',\n    'cvmfs-ubuntu16-04-build': 'worker-cvmfs-ubuntu16-04-build',\n    'cvmfs-ubuntu18-04-build': 'worker-cvmfs-ubuntu18-04-build',\n}\n\ndef setup(cfg):\n\n    ####### WORKERS\n\n    for name in worker_cfgs:\n        cfg['workers'][name] = worker.Worker(\n            name, os.environ['WORKER_PASSWORD'],\n            max_builds=2,\n            properties={\n                'CPUS': '4',\n                'MEMORY': '8000',\n            },\n        )\n\n    ####### CHANGESOURCES\n\n    cfg['change_source']['cvmfs'] = changes.GitPoller(\n        'git://github.com/WIPACrepo/cvmfs.git',\n        workdir=prefix+'-cvmfs-gitpoller-workdir', branch='master',\n        category=prefix,\n        pollinterval=300,\n    )\n\n\n    ####### BUILDERS\n\n    \"\"\" for nightly\n    def isImportant(change):\n        try:\n            if not (os.path.exists(path) and os.listdir(path)):\n                return True # needs rebuilding\n            include = ['setup.cfg','setup.py','requirements.txt']\n            for f in change.files:\n                if f in include:\n                    return True\n            return False\n        except:\n            raise\n            return True\n\n    class SetupCVMFS(steps.BuildStep):\n        def run(self):\n            changes = util.Property('changes')\n            if isImportant(changes):\n                # create a ShellCommand for each stage and add them to the build\n                self.build.addStepsAfterCurrentStep([\n                ])\n                return SUCCESS\n            return SKIPPED\n    \"\"\"\n    \n    @util.renderer\n    def makeCommand(props):\n        command = [\n            'python', 'builders/build.py',\n            '--src', 'icecube.opensciencegrid.org',\n            '--dest', '/cvmfs/icecube.opensciencegrid.org',\n            '--variant', props.getProperty('variant'),\n        ]\n        if props.getProperty('svnonly'):\n            command.extend([\n                '--svnup', 'True',\n                '--svnonly', 'True',\n            ])\n        else:\n            command.extend([\n                '--svnup', 'False',\n            ])\n        if props.getProperty('nightly'):\n            command.append(['--nightly'])\n        return command\n    \n    @util.renderer\n    def makeCommandSpack(props):\n        command = [\n            'python', 'spack/build.py',\n            '--src', 'icecube.opensciencegrid.org',\n            '--dest', '/cvmfs/icecube.opensciencegrid.org',\n            props.getProperty('variant'),\n        ]\n        return command\n\n    build_factory = util.BuildFactory()\n    build_factory.addStep(steps.ShellCommand(\n        name='random sleep',\n        hideStepIf=lambda results,s:True,\n        command=['sleep',random.randint(1,30)],\n    ))\n    build_factory.addStep(steps.Git(\n        repourl='git://github.com/WIPACrepo/cvmfs.git',\n        mode='full',\n        method='clobber',\n        workdir='build',\n    ))\n    build_factory.addStep(steps.ShellCommand(\n        name='build cvmfs',\n        command=makeCommand,\n        env={\n            'CPUS': util.Property('CPUS', default='1'),\n#            'MEMORY': util.Property('MEMORY', default='1'),\n        },\n        workdir='build',\n        haltOnFailure=True,\n        locks=[\n            cfg.locks['cvmfs_shared'].access('counting')\n        ],\n    ))\n    \n\n    build_factory_spack = util.BuildFactory()\n    build_factory_spack.addStep(steps.ShellCommand(\n        name='random sleep',\n        hideStepIf=lambda results,s:True,\n        command=['sleep',random.randint(1,30)],\n    ))\n    build_factory_spack.addStep(steps.Git(\n        repourl='git://github.com/WIPACrepo/cvmfs.git',\n        mode='full',\n        method='clobber',\n        workdir='build',\n    ))\n    build_factory_spack.addStep(steps.ShellCommand(\n        name='build cvmfs',\n        command=makeCommandSpack,\n        env={\n            'CPUS': util.Property('CPUS', default='1'),\n#            'MEMORY': util.Property('MEMORY', default='1'),\n        },\n        workdir='build',\n        haltOnFailure=True,\n        locks=[\n            cfg.locks['cvmfs_shared'].access('counting')\n        ],\n    ))\n\n    @util.renderer\n    def isMetaproject(props):\n        return 'meta' in props.getProperty('variant',default='')\n\n    svn_factory = util.BuildFactory()\n    svn_factory.addStep(steps.Git(\n        repourl='git://github.com/WIPACrepo/cvmfs.git',\n        mode='full',\n        method='clobber',\n        workdir='build',\n    ))\n    svn_factory.addStep(steps.ShellCommand(\n        name='svn checkout',\n        command=makeCommand,\n        env={\n            'CPUS': util.Property('CPUS', default='1'),\n#            'MEMORY': util.Property('MEMORY', default='1'),\n        },\n        workdir='build',\n        haltOnFailure=True,\n        locks=[\n            cfg.locks['cvmfs_shared'].access('exclusive')\n        ],\n        doStepIf=isMetaproject,\n    ))\n    svn_factory.addStep(steps.Trigger(schedulerNames=[prefix+'-build'],\n        waitForFinish=True,\n        updateSourceStamp=True,\n        haltOnFailure=True,\n        set_properties={\n            'variant': util.Property('variant'),\n            'nightly': util.Property('nightly'),\n            'svnonly': False,\n        }\n    ))\n    @util.renderer\n    def translate_variant_to_path(props):\n        variant = str(props.getProperty('variant')).split('_')[:-1]\n        if len(variant) < 2:\n            return variant[0]\n        return variant[0]+'-'+'.'.join(variant[1:])\n    svn_factory.addStep(steps.Trigger(schedulerNames=['publish-trigger'],\n        waitForFinish=True,\n        set_properties={\n            'variant': translate_variant_to_path,\n        }\n    ))\n    \n    spack_master = util.BuildFactory()\n    spack_master.addStep(steps.Git(\n        repourl='git://github.com/WIPACrepo/cvmfs.git',\n        mode='full',\n        method='clobber',\n        workdir='build',\n    ))\n    spack_master.addStep(steps.ShellCommand(\n        name='svn checkout',\n        command=makeCommandSpack,\n        env={\n            'CPUS': util.Property('CPUS', default='1'),\n#            'MEMORY': util.Property('MEMORY', default='1'),\n        },\n        workdir='build',\n        haltOnFailure=True,\n        locks=[\n            cfg.locks['cvmfs_shared'].access('exclusive')\n        ],\n        doStepIf=isMetaproject,\n        timeout=3600*4, # 4 hours - some packages take a long time to build\n    ))\n    spack_master.addStep(steps.Trigger(schedulerNames=[prefix+'-build-spack'],\n        waitForFinish=True,\n        updateSourceStamp=True,\n        haltOnFailure=True,\n        set_properties={\n            'variant': util.Property('variant'),\n            'nightly': util.Property('nightly'),\n            'svnonly': False,\n        }\n    ))\n    @util.renderer\n    def translate_variant_to_path_spack(props):\n        return str(props.getProperty('variant')).replace('-meta','')\n    spack_master.addStep(steps.Trigger(schedulerNames=['publish-trigger'],\n        waitForFinish=True,\n        set_properties={\n            'variant': translate_variant_to_path_spack,\n        }\n    ))\n\n    builders = []\n    for name in worker_cfgs:\n        cfg['builders'][name+'_builder'] = util.BuilderConfig(\n            name=name+'_builder',\n            workername=name,\n            factory=build_factory,\n            properties={},\n        )\n        builders.append(name+'_builder')\n\n    builders_spack = []\n    for name in worker_cfgs:\n        if 'ubuntu14' in name:\n            continue\n        cfg['builders'][name+'_builder_spack'] = util.BuilderConfig(\n            name=name+'_builder_spack',\n            workername=name,\n            factory=build_factory_spack,\n            properties={},\n        )\n        builders_spack.append(name+'_builder_spack')\n\n    cfg['builders']['svn_builder'] = util.BuilderConfig(\n        name='svn_builder',\n        workername='cvmfs-ubuntu18-04-build',\n        factory=svn_factory,\n        properties={},\n    )\n\n    cfg['builders']['svn_builder_spack'] = util.BuilderConfig(\n        name='svn_builder_spack',\n        workername='cvmfs-ubuntu18-04-build',\n        factory=spack_master,\n        properties={},\n    )\n\n    ####### SCHEDULERS\n\n    variants = ['py2_v3.0.1_base','py2_v3.0.1_metaproject','iceprod']\n    for v in variants:\n        cfg['schedulers'][prefix+'-'+v] = schedulers.SingleBranchScheduler(\n            name=prefix+'-'+v,\n            change_filter=util.ChangeFilter(category=prefix),\n            treeStableTimer=None,\n            builderNames=['svn_builder'],\n            properties={'variant':v, 'svnonly':True, 'nightly':False},\n        )\n    cfg['schedulers'][prefix+'-triggerable'] = schedulers.Triggerable(\n        name=prefix+\"-build\",\n        builderNames=builders,\n    )\n    cfg['schedulers'][prefix+'-triggerable-spack'] = schedulers.Triggerable(\n        name=prefix+\"-build-spack\",\n        builderNames=builders_spack,\n    )\n    cfg['schedulers'][prefix+'-force'] = schedulers.ForceScheduler(\n        name=prefix+\"-force\",\n        builderNames=['svn_builder'],\n        properties=[\n            util.StringParameter(name=\"variant\",\n                                 label=\"Variant:\",\n                                 default=\"\", size=80),\n            util.BooleanParameter(name=\"nightly\",\n                                  label=\"Nightly build\",\n                                  default=False),\n            util.FixedParameter(name=\"svnonly\", default=\"True\"),\n        ],\n    )\n    cfg['schedulers'][prefix+'-force-spack'] = schedulers.ForceScheduler(\n        name=prefix+\"-force-spack\",\n        builderNames=['svn_builder_spack'],\n        properties=[\n            util.StringParameter(name=\"variant\",\n                                 label=\"Variant:\",\n                                 default=\"\", size=80),\n            util.BooleanParameter(name=\"nightly\",\n                                  label=\"Nightly build\",\n                                  default=False),\n            util.FixedParameter(name=\"svnonly\", default=\"True\"),\n        ],\n    )\n\n    cfg['schedulers'][prefix+'-nightly'] = schedulers.Nightly(\n        name=prefix+'-nightly',\n        builderNames=['svn_builder'],\n        properties={'variant':'py2_v3_0_1_metaproject', 'svnonly': True, 'nightly':True},\n        hour=0, minute=0,\n    )\n\nconfig = Config(setup)\nconfig.locks['cvmfs_shared'] = util.MasterLock('cvmfs_lock', maxCount=100)\n",
        "stratum0.py": "from __future__ import print_function\n\nimport os\nimport json\n\nfrom buildbot.plugins import *\nfrom buildbot.process.buildstep import SUCCESS,SKIPPED,FAILURE\n\nfrom . import Config, get_os\n\n\nprefix = __file__.split('/')[-1].rsplit('.',1)[0]\n\n\ndef setup(cfg):\n\n    ####### WORKERS\n\n    workername = 'cvmfs-centos7-stratum0'\n    cfg['workers'][prefix] = worker.Worker(\n        workername, os.environ['WORKER_PASSWORD'],\n        max_builds=1,\n        properties={},\n    )\n\n    ####### CHANGESOURCES\n\n    cfg['change_source']['cvmfs'] = changes.GitPoller(\n        'git://github.com/WIPACrepo/cvmfs.git',\n        workdir=prefix+'-cvmfs-gitpoller-workdir', branch='master',\n        category=prefix,\n        pollinterval=300,\n    )\n\n\n    ####### BUILDERS\n\n    \"\"\" for nightly\n    def isImportant(change):\n        try:\n            if not (os.path.exists(path) and os.listdir(path)):\n                return True # needs rebuilding\n            include = ['setup.cfg','setup.py','requirements.txt']\n            for f in change.files:\n                if f in include:\n                    return True\n            return False\n        except:\n            raise\n            return True\n\n    class SetupCVMFS(steps.BuildStep):\n        def run(self):\n            changes = util.Property('changes')\n            if isImportant(changes):\n                # create a ShellCommand for each stage and add them to the build\n                self.build.addStepsAfterCurrentStep([\n                ])\n                return SUCCESS\n            return SKIPPED\n    \"\"\"\n\n    def BuildFailed(step):\n        return step.build.results == FAILURE\n    def BuildPassed(step):\n        return step.build.results == SUCCESS\n\n    factory = util.BuildFactory()\n    factory.addStep(steps.ShellCommand(\n        name='open transaction',\n        command=['cvmfs_server','transaction','icecube.opensciencegrid.org'],\n        haltOnFailure=True,\n    ))\n    factory.addStep(steps.ShellCommand(\n        name='rsync',\n        command=[\n            'cvmfs_rsync','-ai','--delete',\n            util.Interpolate('/cvmfs-source/icecube.opensciencegrid.org/%(prop:variant)s'),\n            '/cvmfs/icecube.opensciencegrid.org/',\n        ],\n        timeout=7200, # 2 hours\n        haltOnFailure=True,\n        doStepIf=BuildPassed,\n    ))\n    factory.addStep(steps.ShellCommand(\n        name='publish transaction',\n        command=['cvmfs_server','publish','icecube.opensciencegrid.org'],\n        timeout=7200, # 2 hours\n        haltOnFailure=True,\n        doStepIf=BuildPassed,\n        hideStepIf=lambda results, s: results==SKIPPED,\n    ))\n    factory.addStep(steps.ShellCommand(\n        name='abort transaction',\n        command=['cvmfs_server','abort','-f','icecube.opensciencegrid.org'],\n        alwaysRun=True,\n        haltOnFailure=True,\n        doStepIf=BuildFailed,\n        hideStepIf=lambda results, s: results==SKIPPED,\n    ))\n\n    cfg['builders'][prefix+'_builder'] = util.BuilderConfig(\n        name=prefix+'_builder',\n        workername=workername,\n        factory=factory,\n        properties={},\n        locks=[\n            cfg.locks['cvmfs_shared'].access('exclusive'),\n            cfg.locks['cvmfs_publish'].access('exclusive')\n        ],\n        collapseRequests=True,\n    )\n    \n    factory_whitelist = util.BuildFactory()\n    factory_whitelist.addStep(steps.ShellCommand(\n        name='resign whitelist',\n        command='cd /srv/cvmfs/icecube.opensciencegrid.org && rm -f .cvmfswhitelist.new && wget -qO .cvmfswhitelist.new http://oasis.opensciencegrid.org/cvmfs/icecube.opensciencegrid.org/.cvmfswhitelist && mv -f .cvmfswhitelist.new .cvmfswhitelist',\n        haltOnFailure=True,\n    ))\n\n    cfg['builders'][prefix+'_whitelist'] = util.BuilderConfig(\n        name=prefix+'_whitelist',\n        workername=workername,\n        factory=factory_whitelist,\n        properties={},\n        locks=[\n            cfg.locks['cvmfs_publish'].access('exclusive')\n        ],\n        collapseRequests=True,\n    )\n    \n    factory_user_rsync = util.BuildFactory()\n    factory_user_rsync.addStep(steps.ShellCommand(\n        name='open transaction',\n        command=['cvmfs_server','transaction','icecube.opensciencegrid.org'],\n        haltOnFailure=True,\n    ))\n    factory_user_rsync.addStep(steps.ShellCommand(\n        name='rsync',\n        command=[\n            'cvmfs_rsync','-ai','--delete',\n            'rsync://nfs-6.icecube.wisc.edu/pcvmfs/',\n            '/cvmfs/icecube.opensciencegrid.org/users/',\n        ],\n        timeout=7200, # 2 hours\n        haltOnFailure=True,\n        doStepIf=BuildPassed,\n    ))\n    factory_user_rsync.addStep(steps.ShellCommand(\n        name='publish transaction',\n        command=['cvmfs_server','publish','icecube.opensciencegrid.org'],\n        timeout=7200, # 2 hours\n        haltOnFailure=True,\n        doStepIf=BuildPassed,\n        hideStepIf=lambda results, s: results==SKIPPED,\n    ))\n    factory_user_rsync.addStep(steps.ShellCommand(\n        name='abort transaction',\n        command=['cvmfs_server','abort','-f','icecube.opensciencegrid.org'],\n        alwaysRun=True,\n        haltOnFailure=True,\n        doStepIf=BuildFailed,\n        hideStepIf=lambda results, s: results==SKIPPED,\n    ))\n\n    cfg['builders'][prefix+'_user_rsync'] = util.BuilderConfig(\n        name=prefix+'_user_rsync',\n        workername=workername,\n        factory=factory_user_rsync,\n        properties={},\n        locks=[\n            cfg.locks['cvmfs_publish'].access('exclusive')\n        ],\n        collapseRequests=True,\n    )\n\n    factory_backup = util.BuildFactory()\n    factory_backup.addStep(steps.ShellCommand(\n        name='rsync',\n        command=['rsync','-ai','--delete','/cvmfs-source/icecube.opensciencegrid.org','rsync://nfs-5.icecube.wisc.edu/cvmfs/'],\n        timeout=14400, # 4 hours\n        haltOnFailure=True,\n    ))\n\n    cfg['builders'][prefix+'_backup'] = util.BuilderConfig(\n        name=prefix+'_backup',\n        workername=workername,\n        factory=factory_backup,\n        properties={},\n        locks=[\n            cfg.locks['cvmfs_shared'].access('exclusive')\n        ],\n        collapseRequests=True,\n    )\n\n    ####### SCHEDULERS\n\n    cfg['schedulers']['publish-force'] = schedulers.ForceScheduler(\n        name=\"publish-force\",\n        builderNames=[prefix+'_builder'],\n        properties=[\n            util.StringParameter(name=\"variant\",\n                                 label=\"Variant:\",\n                                 default=\"\", size=80),\n        ],\n    )\n    cfg['schedulers']['publish-trigger'] = schedulers.Triggerable(\n        name=\"publish-trigger\",\n        builderNames=[prefix+'_builder'],\n    )\n\n    # update the whitelist every day at 3am\n    cfg['schedulers'][prefix+'-whitelist'] = schedulers.Nightly(\n        name=\"whitelist\",\n        builderNames=[prefix+'_whitelist'],\n        hour=3, minute=0,\n    )\n\n    # update the user cvmfs space every hour on the hour\n    cfg['schedulers'][prefix+'-user_rsync'] = schedulers.Nightly(\n        name=\"user cvmfs\",\n        builderNames=[prefix+'_user_rsync'],\n        minute=0,\n    )\n\n    # backup cvmfs the first day of every month, at 4am\n    cfg['schedulers'][prefix+'-backup'] = schedulers.Nightly(\n        name=\"backup\",\n        builderNames=[prefix+'_backup'],\n        dayOfMonth=1, hour=4, minute=0,\n    )\n\n\nconfig = Config(setup)\nconfig.locks['cvmfs_shared'] = util.MasterLock('cvmfs_lock', maxCount=100)\nconfig.locks['cvmfs_publish'] = util.MasterLock('cvmfs_publish', maxCount=1)\n"
    },
    "kind": "ConfigMap",
    "metadata": {
        "name": "cvmfs-buildbot-master-cfg-d"
    }
}